#
# +==== BEGIN AsperBackend =================+
# LOGO:
# ..........####...####..........
# ......###.....#.#########......
# ....##........#.###########....
# ...#..........#.############...
# ...#..........#.#####.######...
# ..#.....##....#.###..#...####..
# .#.....#.##...#.##..##########.
# #.....##########....##...######
# #.....#...##..#.##..####.######
# .#...##....##.#.##..###..#####.
# ..#.##......#.#.####...######..
# ..#...........#.#############..
# ..#...........#.#############..
# ...##.........#.############...
# ......#.......#.#########......
# .......#......#.########.......
# .........#####...#####.........
# /STOP
# PROJECT: AsperBackend
# FILE: validate-production-config.yml
# CREATION DATE: 02-12-2025
# LAST Modified: 17:5:7 02-12-2025
# DESCRIPTION:
# This is the backend server in charge of making the actual website work.
# /STOP
# COPYRIGHT: (c) Asperguide
# PURPOSE: This is the workflow in charge of making sure that developpment elements are not making it into production.
# // AR
# +==== END AsperBackend =================+
#
name: validate_production_config

# version: 1.0.0
# Version log:
# 1.0.0: Initial version - validates that testing endpoints are disabled for production

on:
  push:
    branches:
      - prod
  pull_request:
    branches:
      - prod
  workflow_dispatch:

jobs:
  validate-config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check config.toml exists
        run: |
          if [ ! -f "backend/config.toml" ]; then
            echo "Error: backend/config.toml not found!"
            exit 1
          fi
          echo "Config file found"

      - name: Validate testing endpoints are disabled
        run: |
          # Extract the enable_testing_endpoints value from config.toml
          # This handles various formatting styles (spaces, tabs, etc.)
          TESTING_ENABLED=$(grep -E '^\s*enable_testing_endpoints\s*=' backend/config.toml | sed -E 's/.*=\s*//;s/\s*$//' || echo "not_found")

          echo "Found value: enable_testing_endpoints = $TESTING_ENABLED"

          if [ "$TESTING_ENABLED" = "not_found" ]; then
            echo "Warning: 'enable_testing_endpoints' setting not found in config.toml"
            echo "This could indicate a configuration issue."
            exit 1
          fi

          if [ "$TESTING_ENABLED" = "true" ]; then
            echo "CONFIGURATION ERROR: Testing endpoints are ENABLED!"
            echo ""
            echo "Testing endpoints must be disabled before merging to production."
            echo "Please set 'enable_testing_endpoints = false' in backend/config.toml"
            echo ""
            echo "Current configuration in [Test] section:"
            grep -A 5 "^\[Test\]" backend/config.toml || echo "Could not find [Test] section"
            exit 1
          elif [ "$TESTING_ENABLED" = "false" ]; then
            echo "Testing endpoints are properly disabled for production"
          else
            echo "Unexpected value for enable_testing_endpoints: $TESTING_ENABLED"
            echo "Expected 'true' or 'false'"
            exit 1
          fi
